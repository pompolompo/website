{
  "hash": "5267899e36a3763cbe12403709992102",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Preus a les gasolineres d'Espanya\"\nsubtitle: \"Quinen preus fixen les gasolineres per cada producte al llarg del temps?\"\nimage: \"gas_price.png\"\ntoc: true\ndate: 02-11-2024\nformat: html\n---\n\n\n\n## Quina informació hi ha al [Geoportal](https://geoportalgasolineras.es/geoportal-instalaciones)?\n\n- On s'ón'ubiquen els punts de recàrrega?\n- Quin carburant ofereixen?\n- Quin preu cobren? Com canvia al llarg del temps?\n- Quin horari obre?\n- És d'autoservei?\n- És una cooperativa?\n- Qui n'és el propietari?\n- Existeixen portals similars a Europa\n\n## Com obtenim les dades?\n\n### Connexió amb la API\n\nCal connectarnos a la API del geoportal per obtenir les dades que ens interessen. Descarregarem en format `.json`, que `R` llegirà com  llista. Finalment apilarem totes les observacions en una taula.\n\nEl geoportal ofereix múltiples APIs que donen accés a diferent informació ([Servicios REST](https://geoportalgasolineras.es/geoportal-instalaciones/DescargarFicheros)). Estem interessats en l'evolució dels preus de cada producte així que utilitzem la següent estructura:\n\n**Part comú:** Sempre serà la mateixa\n\n`https://sedeaplicaciones.minetur.gob.es/ServiciosRESTCarburantes/PreciosCarburantes/`\n\n**Part Específica:** Escollirem i parametritzarem en funció de l'informació que volem\n\n`EstacionesTerrestresHist/FiltroProvinciaProducto/{FECHA}/{IDPROVINCIA}/{IDPRODUCTO}`\n\n### Exemple en R\n\nUtilitzarem les següents llibreries d'`R`:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppressWarnings(suppressMessages({\n  library(dplyr)\n  library(purrr)\n  library(httr2)\n}))\n```\n:::\n\n\n\nEstem interessats en el preu de la gasolina 95 E5. Ens centrem en la província de Barcelona i volem l'informació del dia anterior. Els productes i províncies tenen codis associats, codificarem la data en format `dd-mm-yy`:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- format(Sys.Date() - 1, \"%d-%m-%Y\")\nproducte <- \"01\"\nprovincies <- set_names(\n  c(\"08\", \"17\", \"25\", \"43\"), \n  c(\"barcelona\", \"girona\", \"lleida\", \"tarragona\")\n)\n```\n:::\n\n\n\nConstruim l'url per cada província:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbase_url <- provincies %>% \n  map(\\(prov) paste0(\n    \"https://sedeaplicaciones.minetur.gob.es/\",\n    \"ServiciosRESTCarburantes/PreciosCarburantes/\",\n    \"EstacionesTerrestresHist/FiltroProvinciaProducto/\",\n    data, \"/\", prov, \"/\", producte\n))\n```\n:::\n\n\n\nDemanem l'informació, la convertim en llista i l'apilem en una taula per cada província:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresponse <- map(base_url, \\(url) req_perform(request(url)))\n\ntbl <- response %>% \n  map(\\(resp){\n    resp_body_json(resp)[[\"ListaEESSPrecio\"]] %>% \n      map(\\(json) as_tibble(list_flatten(json))) %>% \n      bind_rows() %>% \n      mutate(PrecioProducto = as.numeric(sub(\",\", \".\", PrecioProducto)))\n  })\n```\n:::\n\n\n\nFem una ullada als preus:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwith(list_c(tbl), boxplot(PrecioProducto ~ Provincia, xlab = \"\", ylab = \"\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plot-1-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nhist(list_c(tbl)[[\"PrecioProducto\"]], breaks = 30, main = \"\", xlab = \"\", ylab = \"\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plot-2-1.png){width=672}\n:::\n:::\n\n\n\n## Més enllà\n\n- Mapa de preus de gasolineres\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}