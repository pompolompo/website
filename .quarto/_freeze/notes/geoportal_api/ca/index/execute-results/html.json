{
  "hash": "aef40c9b22fa1e04eaba94d78a632f98",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Preus a les gasolineres d'Espanya\"\nsubtitle: \"Quinen preus fixen les gasolineres per cada producte al llarg del temps?\"\nformat: html\n---\n\n\n\n\n\n## Quina informació hi ha al [Geoportal](https://geoportalgasolineras.es/geoportal-instalaciones)?\n\n- On s'ón'ubiquen els punts de recàrrega?\n- Quin carburant ofereixen?\n- Quin preu cobren? Com canvia al llarg del temps?\n- Quin horari obre?\n- És d'autoservei?\n- És una cooperativa?\n- Qui n'és el propietari?\n- Existeixen portals similars a Europa\n\n## Com obtenim les dades?\n\n### Connexió amb les APIs\n\nCal connectarnos a la API del geoportal per obtenir les dades que ens interessen. Descarregarem en format `.json`, que `R` llegirà com  llista. Finalment apilarem totes les observacions en una taula.\n\nEl geoportal ofereix múltiples APIs que donen accés a diferent informació ([Servicios REST](https://geoportalgasolineras.es/geoportal-instalaciones/DescargarFicheros)). Estem interessats en l'evolució dels preus de cada producte així que utilitzem la següent estructura:\n\n<center>\n`https://sedeaplicaciones.minetur.gob.es/`\n\n`ServiciosRESTCarburantes/PreciosCarburantes/`\n\n`EstacionesTerrestresHist/FiltroProvinciaProducto/`\n\n`{FECHA}/{IDPROVINCIA}/{IDPRODUCTO}`\n\n<\\center>\n\n### Exemple en R\n\nUtilitzarem les següents llibreries d'`R`:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppressWarnings(suppressMessages({\n  library(dplyr)\n  library(purrr)\n  library(httr2)\n}))\n```\n:::\n\n\n\n\n\nSeleccionem la gasolina 95 E5 i codifiquem la data desitjada com `dd-mm-yy`:\n\nEstem interessats en el preu de la gasolina 95 E5 a la província de Barcelona amb informació del dia anterior.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- format(Sys.Date() - 1, \"%d-%m-%Y\")\nproducte <- \"01\"\nprovincies <- set_names(\n  c(\"08\", \"17\", \"25\", \"43\"), \n  c(\"barcelona\", \"girona\", \"lleida\", \"tarragona\")\n)\n\nbase_url <- provincies %>% \n  map(\\(prov){\n    paste0(\n      \"https://sedeaplicaciones.minetur.gob.es/\",\n      \"ServiciosRESTCarburantes/PreciosCarburantes/\",\n      \"EstacionesTerrestresHist/FiltroProvinciaProducto/\",\n      data, \"/\", prov, \"/\", producte\n    )\n  })\n```\n:::\n\n\n\n\n\nDemanem l'informació i la convertim en taula:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresponse <- base_url %>% \n  map(\\(url) req_perform(request(url)))\n\ntbl <- response %>% \n  map(\\(resp){\n    resp_body_json(resp)[[\"ListaEESSPrecio\"]] %>% \n      map(\\(json) as_tibble(list_flatten(json))) %>% \n      bind_rows() %>% \n      mutate(PrecioProducto = as.numeric(sub(\",\", \".\", PrecioProducto)))\n  })\n```\n:::\n\n\n\n\n\nFem una ullada a la distribució de preus:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwith(list_c(tbl), boxplot((PrecioProducto ~ Provincia)))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plot-1.png){width=672}\n:::\n\n```{.r .cell-code}\nhist(list_c(tbl)[[\"PrecioProducto\"]], breaks = 30)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plot-2.png){width=672}\n:::\n:::\n\n\n\n\n\n## Més enllà\n\n- Mapa de preus de gasolineres\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}